# 批量扫码功能设计方案

**需求分析日期**：2026年1月29日  
**优先级**：高  
**类型**：新功能

---

## 📋 需求分析

### 用户场景

1. **仓库管理**
   - 批量扫描商品条码
   - 清点库存

2. **活动签到**
   - 批量扫描参与者二维码
   - 快速统计人数

3. **物流配送**
   - 批量扫描包裹条码
   - 批量录入运单号

4. **门店收银**
   - 连续扫描商品
   - 快速结算

### 竞品分析

#### 主流 QR 扫描应用的批量功能

1. **草料二维码**
   - ✅ 连续扫描模式
   - ✅ 自动保存每次扫描
   - ✅ 导出为 Excel
   - ✅ 去重选项

2. **扫描全能王**
   - ✅ 批量扫描列表
   - ✅ 实时统计
   - ✅ 分类管理
   - ✅ CSV 导出

3. **二维码扫描器（QR Scanner）**
   - ✅ 批量模式开关
   - ✅ 扫描计数
   - ✅ 快速清空
   - ✅ 分享列表

### 核心需求

#### 必须功能（MVP）
- ✅ 连续扫描模式
- ✅ 实时显示扫描列表
- ✅ 扫描计数统计
- ✅ 去重选项
- ✅ 清空列表
- ✅ 导出为 CSV/TXT

#### 重要功能（Phase 2）
- ⏳ 导出为 Excel
- ⏳ 扫描记录分组
- ⏳ 扫描间隔设置
- ⏳ 扫描音效提示

#### 未来功能（Phase 3+）
- ⏳ 云端同步
- ⏳ 团队协作
- ⏳ 数据分析

---

## 🎨 UI/UX 设计

### 入口设计

#### 方案 1：扫描页面顶部按钮（推荐）
```
+---------------------------+
| [<] 扫描      [批量模式] |
|                           |
|    +---------------+      |
|    |   相机预览    |      |
|    |               |      |
|    +---------------+      |
|                           |
|  将二维码放入框内         |
+---------------------------+
```

**优点**：
- 入口明显
- 不打断当前流程
- 一键切换

#### 方案 2：底部导航新增（暂不采用）
```
[扫描] [生成] [批量] [历史]
```

**缺点**：
- 导航项过多
- 功能不够频繁使用

### 批量扫描页面

```
+---------------------------+
| [<] 批量扫描   [完成]      |
+---------------------------+
| 已扫描: 15  去重: ☑       |
+---------------------------+
|    +---------------+      |
|    |   相机预览    |      |
|    +---------------+      |
+---------------------------+
| 最近扫描:                 |
| +---------------------+   |
| | 1. https://...      |   |
| | 2. 13800138000      |   |
| | 3. WIFI:T:WPA...    |   |
| +---------------------+   |
|                           |
| [清空列表] [导出]         |
+---------------------------+
```

### 完成页面

```
+---------------------------+
| [<] 扫描结果              |
+---------------------------+
| 总计: 15 条               |
| 去重后: 12 条             |
+---------------------------+
| ☑ 全选                    |
|                           |
| [ ] 1. https://example... |
| [ ] 2. 13800138000        |
| [ ] 3. WIFI:T:WPA;...     |
| ...                       |
|                           |
| [导出 CSV] [导出 TXT]     |
| [分享] [保存到历史]       |
+---------------------------+
```

---

## 🏗️ 技术架构

### 数据模型

#### BatchScanSession（批量扫描会话）
```dart
class BatchScanSession {
  String id;                    // 会话 ID
  DateTime startTime;           // 开始时间
  DateTime? endTime;            // 结束时间
  List<ScanResult> results;     // 扫描结果列表
  bool enableDeduplicate;       // 启用去重
  int totalScans;               // 总扫描次数
  int uniqueScans;              // 去重后数量
}
```

#### BatchScanSettings（批量扫描设置）
```dart
class BatchScanSettings {
  bool enableDeduplicate;       // 去重
  int scanDelay;                // 扫描间隔（毫秒）
  bool enableSound;             // 音效
  bool enableVibration;         // 震动
  int maxScans;                 // 最大扫描数
}
```

### 服务层

#### BatchScannerService
```dart
class BatchScannerService {
  // 开始批量扫描会话
  Future<BatchScanSession> startSession();
  
  // 添加扫描结果
  Future<void> addScanResult(ScanResult result);
  
  // 结束会话
  Future<void> endSession();
  
  // 导出为 CSV
  Future<String> exportToCSV(List<ScanResult> results);
  
  // 导出为 TXT
  Future<String> exportToTXT(List<ScanResult> results);
  
  // 去重
  List<ScanResult> deduplicate(List<ScanResult> results);
}
```

### Provider 层

#### BatchScanProvider
```dart
class BatchScanProvider extends ChangeNotifier {
  BatchScanSession? _currentSession;
  bool _isScanning = false;
  bool _enableDeduplicate = true;
  
  // 开始批量扫描
  Future<void> startBatchScan();
  
  // 停止批量扫描
  Future<void> stopBatchScan();
  
  // 添加扫描结果
  Future<void> addResult(ScanResult result);
  
  // 清空列表
  void clearResults();
  
  // 导出
  Future<void> export(ExportFormat format);
}
```

---

## 🔧 实现细节

### 连续扫描逻辑

```dart
// 1. 扫描到新结果
onDetect: (capture) {
  final result = provider.parseScanResult(capture);
  
  // 2. 检查是否需要去重
  if (provider.enableDeduplicate) {
    if (provider.isDuplicate(result)) {
      // 显示"已扫描"提示
      showDuplicateToast();
      return;
    }
  }
  
  // 3. 添加到列表
  provider.addResult(result);
  
  // 4. 播放提示音
  playBeep();
  
  // 5. 震动反馈
  HapticFeedback.lightImpact();
  
  // 6. 延迟后继续扫描（避免重复扫描同一个码）
  await Future.delayed(Duration(milliseconds: 500));
}
```

### 去重算法

```dart
bool isDuplicate(ScanResult newResult) {
  return _results.any((r) => 
    r.rawValue == newResult.rawValue
  );
}
```

### CSV 导出格式

```csv
序号,类型,内容,扫描时间
1,URL,https://example.com,2026-01-29 15:30:00
2,电话,13800138000,2026-01-29 15:30:05
3,WiFi,WIFI:T:WPA;S:MyNetwork;P:password;;,2026-01-29 15:30:10
```

### TXT 导出格式

```txt
SmartScan 批量扫描结果
扫描时间：2026-01-29 15:30:00
总计：15 条
去重后：12 条
---------------------------------
1. https://example.com
2. 13800138000
3. WIFI:T:WPA;S:MyNetwork;P:password;;
...
```

---

## 📦 需要的依赖

```yaml
dependencies:
  # 文件操作
  path_provider: ^2.1.0  # 已有
  
  # CSV 生成
  csv: ^6.0.0  # 新增
  
  # 震动反馈
  vibration: ^2.0.0  # 可选
  
  # 音效
  audioplayers: ^6.0.0  # 可选
```

---

## 🎯 实现计划

### Phase 1：核心功能（本次实现）

#### 1. 数据层 ✅
- [x] BatchScanSession 模型
- [x] 批量扫描设置

#### 2. 服务层 ✅
- [x] BatchScannerService
- [x] CSV 导出
- [x] TXT 导出
- [x] 去重逻辑

#### 3. Provider 层 ✅
- [x] BatchScanProvider
- [x] 状态管理

#### 4. UI 层 ✅
- [x] 批量扫描页面
- [x] 扫描结果列表
- [x] 导出分享功能

#### 5. 国际化 ✅
- [x] 中英文翻译

### Phase 2：增强功能（后续）
- [ ] Excel 导出
- [ ] 扫描音效
- [ ] 震动反馈
- [ ] 分组管理

---

## ✅ 验收标准

### 功能验收
- [ ] 能够连续扫描多个二维码
- [ ] 实时显示扫描列表
- [ ] 显示扫描数量统计
- [ ] 去重功能正常
- [ ] 能够清空列表
- [ ] 能够导出 CSV
- [ ] 能够导出 TXT
- [ ] 能够分享结果

### 性能验收
- [ ] 扫描响应速度 < 500ms
- [ ] 列表滚动流畅（100+ 条）
- [ ] 导出速度 < 2s（1000条）
- [ ] 内存占用合理

### 用户体验
- [ ] 操作直观易懂
- [ ] 有清晰的状态提示
- [ ] 错误处理友好
- [ ] 支持中英文

---

## 🚀 预期效果

### 用户价值
1. **提高效率**：一次扫描多个二维码，节省时间
2. **数据管理**：导出功能方便后续处理
3. **去重功能**：避免重复录入
4. **专业性**：满足商业场景需求

### 竞争优势
1. ✅ 简洁易用的界面
2. ✅ 多种导出格式
3. ✅ 实时去重
4. ✅ 免费无广告

---

## 📊 时间估算

- 数据模型：10 分钟
- 服务层：20 分钟
- Provider：15 分钟
- UI 页面：30 分钟
- 国际化：10 分钟
- 测试调试：15 分钟

**总计**：~100 分钟（1.5-2 小时）

---

**设计状态**：✅ 完成  
**下一步**：开始实现
